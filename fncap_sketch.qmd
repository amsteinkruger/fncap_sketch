---
title: "Processing FIA Data for FNCAP"
format: gfm
editor: visual
---

# Objectives

This document processes FIA data, then sets up initial exploration and visualization for growth modeling.

The next step is to add growth models following Hashida and Fenichel (2021).

# Results Preview

-   Processing FIA data for private Douglas Fir stands in western Oregon returns 551 plots.

    -   (That is, 551 plots with at least one pair of observations over time.)

-   A fair number of plots decrease in volume between observations.

-   That, plus data handling decisions around age (FLDAGE), limits modeling.

# Code and Results

```{r packages, include = FALSE}

library(tidyverse)
library(ggpubr)

options(scipen = 999)

```

## 1. Data

```{r data, output = FALSE}

dat_or_plot = "data/OR_PLOT.csv" %>% read_csv # 9 MB

dat_or_cond = "data/OR_COND.csv" %>% read_csv # 18 MB

dat_or_tree = "data/OR_TREE.csv" %>% read_csv # 429 MB

```

## 2. Filtering Plots

```{r filter_plots, output = FALSE}

# 2. Filter plots to those (a) in western Oregon (b) with at least one pair of observations.

dat_or_plot_less = 
  dat_or_plot %>% 
  # Filter to western Oregon.
  filter(LON < -120) %>% 
  # Filter to pairs of observations.
  #  This drops plots without multiple observations.
  mutate(MATCH_CN = ifelse(is.na(PREV_PLT_CN), CN, PREV_PLT_CN)) %>% 
  group_by(MATCH_CN) %>% 
  filter(n() > 1) %>%
  ungroup %>% 
  # Select columns to keep for joins.
  select(STATECD, 
         UNITCD, 
         COUNTYCD, 
         PLOT, 
         MATCH_CN,
         INVYR, 
         MEASYEAR, 
         LON, 
         LAT)

```

## 3. Filtering Conditions

```{r filter_conditions, output = FALSE}

# 3. Filter conditions to private Douglas fir.

dat_or_cond_less = 
  dat_or_cond %>% 
  # Filter.
  filter(FORTYPCD %in% 201:203 & OWNGRPCD == 40) %>% 
  # Select columns to keep for joins. 
  select(STATECD, 
         UNITCD, 
         COUNTYCD, 
         PLOT, 
         CONDID, 
         CONDPROP_UNADJ,
         INVYR, 
         FLDAGE,
         STDAGE,
         SITECLCD,
         DSTRBCD1, 
         DSTRBYR1, 
         TRTCD1, 
         TRTYR1)

```

## 4. Filtering Trees

```{r filter_trees, output = FALSE}

# 4. Join filters on plot and condition.

dat_or_keep = 
  dat_or_cond_less %>% 
  left_join(dat_or_plot_less) %>% 
  semi_join(dat_or_plot_less)

# 5. Use the result of (4) to filter trees, then filter trees to Douglas fir.

dat_or_tree_less = 
  dat_or_tree %>% 
  # Select columns that we might use.
  select(ends_with("CN"),
         STATECD,
         UNITCD,
         COUNTYCD,
         PLOT,
         CONDID,
         TREE,
         INVYR,
         # STATUSCD,
         SPGRPCD,
         SPCD,
         # TOTAGE,
         # BHAGE,
         # starts_with("VOL"),
         VOLCFNET,
         # starts_with("DRYBIO"),
         # DRYBIO_AG,
         # DRYBIO_BG,
         # starts_with("CARBON"),
         # CARBON_AG,
         # CARBON_BG,
         TPA_UNADJ) %>% 
  # Get plot and condition information.
  left_join(dat_or_keep,
            by = c("STATECD", "UNITCD", "COUNTYCD", "PLOT", "CONDID", "INVYR")) %>% 
  # Filter on plot and condition.
  semi_join(dat_or_keep,
            by = c("STATECD", "UNITCD", "COUNTYCD", "PLOT", "CONDID", "INVYR")) %>% 
  # Filter on species group (down to Douglas firs). 
  filter(SPGRPCD == 10) 

```

## 5. Aggregation and Pivot

```{r aggregate, output = FALSE}

# 6. Aggregate to plot-acres (?!), then pivot so that rows are plots with timesteps in columns.

dat_or_tree_wide = 
  dat_or_tree_less %>% 
  group_by(STATECD, # Mind implicit drops.
           UNITCD, 
           COUNTYCD, 
           PLOT, 
           # CONDID, 
           MATCH_CN, 
           INVYR, 
           MEASYEAR, 
           # FLDAGE, 
           # STDAGE, 
           LON, 
           LAT) %>% 
  # Aggregate to plot. 
  summarize(VOLCFNET = sum(VOLCFNET * TPA_UNADJ, na.rm = TRUE)) %>% 
  ungroup %>% 
  group_by(STATECD, UNITCD, COUNTYCD, PLOT) %>% 
  # Drop stands with more or fewer than two observations.
  filter(n() == 2) %>%  
  mutate(PLOT_UID = paste(STATECD, UNITCD, COUNTYCD, PLOT, sep = "_")) %>% 
  ungroup %>% 
  select(-c(STATECD, UNITCD, COUNTYCD, PLOT)) %>%
  relocate(PLOT_UID) %>% 
  arrange(PLOT_UID) %>% 
  group_by(PLOT_UID) %>% 
  # Get an ID for first/second observations.
  #  Note that including STDAGE depends on handling conditions.
  mutate(WHICH = ifelse(MEASYEAR == max(MEASYEAR), 1, 0)) %>% 
  ungroup %>% 
  pivot_wider(names_from = WHICH,
              values_from = c(INVYR, MEASYEAR, VOLCFNET)) %>% # STDAGE, 
  mutate(MEASYEAR_D = MEASYEAR_1 - MEASYEAR_0,
         # STDAGE_D = STDAGE_1 - STDAGE_0,
         VOLCFNET_D = VOLCFNET_1 - VOLCFNET_0,
         VOLCFNET_P = VOLCFNET_1 / VOLCFNET_0 - 1) 

```

## 6. Histograms

```{r visualization_histograms, echo = FALSE, output = FALSE}

# hist(dat_or_tree_wide$MEASYEAR_0)
# hist(dat_or_tree_wide$MEASYEAR_1)
# hist(dat_or_tree_wide$MEASYEAR_D)

vis_histogram_years = 
  dat_or_tree_wide %>% 
  select(MEASYEAR_0, MEASYEAR_1) %>% 
  pivot_longer(cols = everything(),
               names_to = "which",
               names_prefix = "MEASYEAR",
               values_to = "year") %>% 
  mutate(which = ifelse(which == "_0", "First", "Second")) %>% 
  group_by(which, year) %>% 
  summarize(count = n()) %>% 
  ungroup %>% 
  arrange(year, which) %>% 
  mutate(year = year %>% factor) %>% 
  ggplot() +
  geom_col(aes(x = year,
               y = count,
               fill = which,
               color = which)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(y = "Observations",
       fill = "Observation",
       color = "Observation") +
  theme_pubr() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggsave("figures/vis_histogram_years.png",
       vis_histogram_years,
       dpi = 300,
       width = 6.0,
       height = 4.0,
       bg = "transparent")

# differences

# hist(dat_or_tree_wide$MEASYEAR_1 - dat_or_tree_wide$MEASYEAR_0)

vis_histogram_years_differences = 
  dat_or_tree_wide %>% 
  ggplot() +
  geom_histogram(aes(x = MEASYEAR_D),
                 binwidth = 1) +
  scale_x_continuous(breaks = 8:12) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Difference in Measurement Years",
       y = "Observations") +
  theme_pubr()

ggsave("figures/vis_histogram_years_differences.png",
       vis_histogram_years_differences,
       dpi = 300,
       width = 3.0,
       height = 4.0,
       bg = "transparent")

# volumes

# hist(dat_or_tree_wide$VOLCFNET_0)
# hist(dat_or_tree_wide$VOLCFNET_1)
# hist(dat_or_tree_wide$VOLCFNET_D)

vis_histogram_volumes = 
  dat_or_tree_wide %>% 
  select(VOLCFNET_0, VOLCFNET_1) %>% 
  pivot_longer(cols = everything(),
               names_to = "which",
               names_prefix = "VOLCFNET",
               values_to = "volume") %>% 
  mutate(which = ifelse(which == "_0", "First", "Second"),
         bin = volume %>% cut(breaks = seq(0, 22000, by = 1000),
                              labels = paste(seq(0, 21000, by = 1000),
                                             seq(1000, 22000, by = 1000),
                                             sep = "-")),
         bin = bin %>% fct_na_value_to_level("Negative")) %>% 
  group_by(which, bin) %>% 
  summarize(count = n()) %>% 
  ungroup %>% 
  arrange(bin, which) %>% 
  ggplot() +
  geom_col(aes(x = bin,
               y = count,
               fill = which,
               color = which),
           position = "dodge") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Plot Volume/Acre (VOLCFNET, Net Cubic-Foot Stem Wood Volume)",
       y = "Observations",
       fill = "Observation",
       color = "Observation") +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggsave("figures/vis_histogram_volumes.png",
       vis_histogram_volumes,
       dpi = 300,
       width = 6.0,
       height = 4.0,
       bg = "transparent")

# differences

# hist(dat_or_tree_wide$MEASYEAR_1 - dat_or_tree_wide$MEASYEAR_0)

vis_histogram_volumes_differences = 
  dat_or_tree_wide %>% 
  select(VOLCFNET_D) %>% 
  mutate(bin = VOLCFNET_D %>% cut(breaks = seq(0, 5000, by = 1000),
                                  labels = paste(seq(0, 4000, by = 1000),
                                                 seq(1000, 5000, by = 1000),
                                                 sep = "-")),
         bin = bin %>% fct_na_value_to_level("Negative")) %>% 
  group_by(bin) %>% 
  summarize(count = n()) %>% 
  ungroup %>% 
  arrange(bin) %>% 
  ggplot() +
  geom_col(aes(x = bin,
               y = count)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Change in Plot Volume/Acre (VOLCFNET)",
       y = "Observations",
       fill = "Observation",
       color = "Observation") +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggsave("figures/vis_histogram_volumes_differences.png",
       vis_histogram_volumes_differences,
       dpi = 300,
       width = 6.0,
       height = 4.0,
       bg = "transparent")

```

Text.

![](figures/vis_histogram_years.png){fig-alt="Years of first and second observations." fig-align="center" width="80%"}

Text.

![](figures/vis_histogram_years_differences.png){fig-alt="Differences in years of observations." fig-align="center" width="40%"}

Text.

![](figures/vis_histogram_volumes.png){fig-alt="Volumes." fig-align="center" width="80%"}

Text.

![](figures/vis_histogram_volumes_differences.png){fig-alt="Differences in volumes." fig-align="center" width="80%"}

Text.

# Discussion
